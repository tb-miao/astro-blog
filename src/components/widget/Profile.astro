---
import { Icon } from "astro-icon/components";
import ImageWrapper from "@/components/common/ImageWrapper.astro";
import { profileConfig } from "@/config/profileConfig";
import { url } from "@/utils/url-utils";
---

<div class="card-base p-3">
<div id="hitokoto-container" class="text-center mb-2">
  <div class="text-neutral-500 dark:text-neutral-400 text-center mb-2"><b>一言 / hitokoto</b></div>
  <div id="hitokoto-text" class="text-sm italic text-neutral-500 dark:text-neutral-400 animate-pulse">正在加载一言...</div>
  <div id="hitokoto-from" class="text-xs text-neutral-400 dark:text-neutral-500 mt-1"></div>
</div>
<div class="border-b border-neutral-300 dark:border-neutral-600 my-2"></div>
  <a
    aria-label="Go to About Page"
    href={url("/about/")}
    class="group block relative mx-auto mt-1 lg:mx-0 lg:mt-0 mb-3
       max-w-[12rem] lg:max-w-none overflow-hidden rounded-xl active:scale-95"
  >
    <div
      class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50
        w-full h-full z-50 flex items-center justify-center"
    >
      <Icon
        name="fa6-regular:address-card"
        class="transition opacity-0 scale-90 group-hover:scale-100 group-hover:opacity-100 text-white text-5xl"
      />
    </div>
    <ImageWrapper
      src={profileConfig.avatar || ""}
      alt="Profile Image of the Author"
      class="mx-auto lg:w-full h-full lg:mt-0"
    />
  </a>
  <div class="px-2">
    <div
      class="font-bold text-xl text-center mb-1 dark:text-neutral-50 transition"
    >
      {profileConfig.name}
    </div>
    <div
      class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2 transition"
    >
    </div>
    <div class="text-center text-neutral-400 mb-2.5 transition">
      {profileConfig.bio}
    </div>
        <div class="flex flex-wrap gap-2 justify-center mb-1">
            {profileConfig.links.length > 1 && profileConfig.links.map(item =>
                    {
                    const showName = item.showName;
                    const className = showName 
                        ? "btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95" 
                        : "btn-regular rounded-lg h-10 w-10 active:scale-90";

                    if (item.url.startsWith("mailto:")) {
                        const encodedEmail = Buffer.from(item.url.replace("mailto:", "")).toString("base64");
                        return <a rel="me" aria-label={item.name} href="#" data-encoded-email={encodedEmail} onclick={`
                                            (function() {
                                                const encodedEmail = this.getAttribute('data-encoded-email');
                                                const decodedEmail = atob(encodedEmail);
                                                this.href = 'mailto:' + decodedEmail;
                                                this.removeAttribute('data-encoded-email');
                                                this.removeAttribute('onclick');
                                                this.click();
                                                return false;
                                            }).call(this);
                                        `.replace(/\s+/g, " ").trim()
                                    },
                                    class={className}>
                            <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                            {showName && item.name}
                        </a>
                    } else {
                        return <a rel="me" aria-label={item.name} href={item.url} target="_blank" class={className}>
                            <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                            {showName && item.name}
                        </a>
                    }
                    }
            )}
            {profileConfig.links.length == 1 && (function(item){
                if (item.url.startsWith("mailto:")) {
                        const encodedEmail = Buffer.from(item.url.replace("mailto:", "")).toString("base64");
                        return <a rel="me" aria-label={item.name} href="#" data-encoded-email={encodedEmail} onclick={`
                                            (function() {
                                                const encodedEmail = this.getAttribute('data-encoded-email');
                                                const decodedEmail = atob(encodedEmail);
                                                this.href = 'mailto:' + decodedEmail;
                                                this.removeAttribute('data-encoded-email');
                                                this.removeAttribute('onclick');
                                                this.click();
                                                return false;
                                            }).call(this);
                                        `.replace(/\s+/g, " ").trim()
                                    },
                                    class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
                            <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                            {item.name}
                        </a>
                    } else {
                        return <a rel="me" aria-label={item.name} href={item.url} target="_blank"
                                            class="btn-regular rounded-lg h-10 gap-2 px-3 font-bold active:scale-95">
                                <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                                {item.name}
                            </a>
                    }
            })(profileConfig.links[0])}
        </div>
  </div>
  <!-- 多网站状态检测 -->
    {profileConfig.websiteStatus?.enable && profileConfig.websiteStatus.websites && (
      <div class="mb-3" data-check-interval={profileConfig.websiteStatus.checkInterval || 30000}>
        <div class="border-b border-neutral-300 dark:border-neutral-600 my-2"></div>
        <div class="text-sm font-medium text-neutral-600 dark:text-neutral-400 text-center mb-2"><b>网站状态监控</b></div>
        <div class="space-y-2">
          {profileConfig.websiteStatus.websites.map((website, index) => (
            <div class="flex items-center justify-between p-2 bg-neutral-50 dark:bg-neutral-800 rounded-lg" 
                 data-website-index={index}
                 data-website-name={website.name}
                 data-website-url={website.url || ""}>
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-gray-400 animate-pulse" id={`status-indicator-${index}`}></div>
                <span class="text-sm font-medium"><b><a href={website.url} target="_blank">{website.name}</a></b></span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-neutral-500" id={`status-text-${index}`}>检测中...</span>
                <span class="text-xs text-neutral-500" id={`response-time-${index}`}></span>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}
            <!-- 最新 Commit 提交信息 -->
        <div class="text-center text-sm text-neutral-500 dark:text-neutral-400 mt-3 pt-3 border-t border-neutral-200 dark:border-neutral-700">
            <div class="flex items-center justify-center gap-1">
                <Icon name="fa6-brands:git-alt" class="text-xl"></Icon>
                <span><a id="github-commit-link" href="#">
                <span id="github-commit">加载中...</span></a></span>
            </div>
        </div>
</div>


<!-- 获取 Commit 信息 via API -->
<script>
    async function loadCommitStats() {
        try {
            const statsElement = document.getElementById('github-commit'); // 查找 id
            const link = document.getElementById('github-commit-link'); // 查找 id
            
            // 第一步：调用 API                
            const githubResponse = await fetch(`https://api.github.com/repos/tb-miao/astro-blog/commits?per_page=1`);

            if (!githubResponse.ok) {
                throw new Error('获取信息失败');
            }

            let Data = await githubResponse.json();
            Data = Data[0];
            // 第二步：获取 Commit 数据
            const latestCommit = Data;
            
            const commitData = {
                hash: latestCommit.sha.slice(0, 7),
                fullHash: latestCommit.sha,
                message: latestCommit.commit.message.split('\n')[0],
                author: latestCommit.commit.author.name,
                date: latestCommit.commit.author.date,
                url: latestCommit.html_url
            };
            
            
            if (statsElement) {
                statsElement.textContent = `当前提交：${Data.sha.slice(0,7)}`;
            }
            

            if (link){
            // const gurl = "https://github.com/tb-miao/astro-blog/commit/"+Data.sha;
            const gurl = "/info/";
                link.href = gurl;
                link.title = "("+Data.commit.committer.date + ")" + " " + Data.commit.message;
            }
        } catch (error) {
            console.error('获取 Commit 信息失败:', error);  
            const statsElement = document.getElementById('github-commit');
            if (statsElement) {
                statsElement.textContent = '提交信息不可用';
            }
        }
    }

    // 页面加载完成后获取 Commit 数据
    document.addEventListener('DOMContentLoaded', loadCommitStats);
</script>

<script>
// 多网站状态检测功能
document.addEventListener('DOMContentLoaded', function() {
  // 获取一言功能
  async function fetchHitokoto() {
    try {
      const response = await fetch('https://v1.hitokoto.cn/');
      const data = await response.json();
      document.getElementById('hitokoto-text').textContent = data.hitokoto;
      document.getElementById('hitokoto-from').textContent = `—— ${data.from}`;
      document.getElementById('hitokoto-text').classList.remove('animate-pulse');
    } catch (error) {
      document.getElementById('hitokoto-text').textContent = '获取一言失败';
      document.getElementById('hitokoto-from').textContent = '';
    }
  }
  
  fetchHitokoto();
  const websiteStatusContainer = document.querySelector('[data-check-interval]');
  
  // 如果网站状态检测功能被禁用或容器不存在，则退出
  if (!websiteStatusContainer) return;
  
  // 获取所有网站状态项
  const websiteItems = document.querySelectorAll('[data-website-index]');
  
  // 如果没有任何网站配置，则退出
  if (websiteItems.length === 0) return;
  
  // 从数据属性获取配置间隔
  const checkInterval = parseInt(websiteStatusContainer.dataset.checkInterval) || 30000;
  
    // 为每个网站创建检测函数
    async function checkWebsiteStatus(websiteItem) {
      const index = websiteItem.dataset.websiteIndex;
      const websiteName = websiteItem.dataset.websiteName;
      const configUrl = websiteItem.dataset.websiteUrl;
      
      const statusIndicator = document.getElementById(`status-indicator-${index}`);
      const statusText = document.getElementById(`status-text-${index}`);
      const responseTime = document.getElementById(`response-time-${index}`);
      
      // 确定要检测的网站URL
      const websiteUrl = configUrl.trim() ? configUrl : window.location.origin;
      
      try {
        const startTime = performance.now();
        
        // 使用 AbortController 设置超时（5秒）
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        // 使用 HEAD 请求检测网站状态，减少数据传输
        const response = await fetch(websiteUrl, {
          method: 'HEAD',
          cache: 'no-cache',
          mode: 'no-cors', // 避免CORS问题
          signal: controller.signal,
          headers: {
            'User-Agent': 'Mozilla/5.0 (compatible; WebsiteStatusChecker/1.0)'
          }
        });
        
        clearTimeout(timeoutId);
        const endTime = performance.now();
        const responseTimeMs = Math.round(endTime - startTime);
        
        // 对于 no-cors 模式，response.ok 可能不可用，检查响应类型
        if (response.type === 'opaque') {
          // no-cors 模式下，只要没有错误就认为在线
          statusIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
          statusText.textContent = '在线';
          responseTime.textContent = `${responseTimeMs}ms`;
        } else if (response.ok) {
          // 正常模式下检查响应状态
          statusIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
          statusText.textContent = '在线';
          responseTime.textContent = `${responseTimeMs}ms`;
        } else {
          // 网站返回错误状态
          statusIndicator.className = 'w-2 h-2 rounded-full bg-yellow-500';
          statusText.textContent = '异常';
          responseTime.textContent = `${response.status}`;
        }
        
      } catch (error) {
        // 更详细的错误处理
        if (error.name === 'AbortError') {
          statusIndicator.className = 'w-2 h-2 rounded-full bg-red-500';
          statusText.textContent = '超时';
          responseTime.textContent = '>5s';
        } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          statusIndicator.className = 'w-2 h-2 rounded-full bg-red-500';
          statusText.textContent = '网络错误';
          responseTime.textContent = '错误';
        } else {
          statusIndicator.className = 'w-2 h-2 rounded-full bg-red-500';
          statusText.textContent = '离线';
          responseTime.textContent = '错误';
        }
      }
    }
  
  // 检测所有网站状态
  async function checkAllWebsites() {
    const promises = Array.from(websiteItems).map(websiteItem => 
      checkWebsiteStatus(websiteItem)
    );
    
    // 同时检测所有网站，但等待所有检测完成
    await Promise.allSettled(promises);
  }
  
  // 页面加载时立即检测所有网站
  checkAllWebsites();
  
  // 根据配置间隔自动检测所有网站
  setInterval(checkAllWebsites, checkInterval);
});
</script>
